<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëª¨ë°”ì¼ ê°ì²´ ì¸ì‹ ë° ìŒì„± ì•ˆë‚´</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #f8f9fa;
        }
        /* ì»¨í…Œì´ë„ˆì— ìƒí•˜ íŒ¨ë”©ì„ ì£¼ì–´ ì½˜í…ì¸ ê°€ í™”ë©´ ê°€ì¥ìë¦¬ì— ë¶™ì§€ ì•Šë„ë¡ í•¨ */
        .container {
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        #video-container {
            position: relative;
            /* ëª¨ë°”ì¼ í™”ë©´ì— ê½‰ ì°¨ë„ë¡ ë„ˆë¹„ 100% ì„¤ì • */
            width: 100%;
            background-color: #000; /* ë¹„ë””ì˜¤ ë¡œë”© ì¤‘ ê²€ì€ ë°°ê²½ */
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        /* ë¹„ë””ì˜¤ í™”ë©´ ë¹„ìœ¨ì„ ìœ ì§€í•˜ê¸° ìœ„í•œ ìŠ¤íƒ€ì¼ (4:3 ë¹„ìœ¨) */
        #video-container::before {
            content: "";
            display: block;
            padding-top: 75%; /* 4:3 Aspect Ratio */
        }
        video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>

    <div class="container text-center">

        <h1 class="h3 fw-bold mt-2">ê°ì²´ ì¸ì‹ ë° ìŒì„± ì•ˆë‚´ ğŸ“·ğŸ”Š</h1>
        <p class="mb-3">ìŠ¤ë§ˆíŠ¸í° í›„ë©´ ì¹´ë©”ë¼ë¡œ ì‚¬ë¬¼ì„ ë¹„ì¶°ë³´ì„¸ìš”.</p>

        <div id="status" class="alert alert-info" role="alert">
            ëª¨ë¸ì„ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...
        </div>

        <div id="video-container" class="shadow-sm rounded overflow-hidden mb-3">
            <video id="webcam" autoplay muted playsinline></video>
            <canvas id="canvas"></canvas>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@latest/dist/coco-ssd.min.js"></script>

    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('canvas');
        const statusDiv = document.getElementById('status');
        const ctx = canvas.getContext('2d');

        let model = undefined;
        let previouslyDetected = new Set();

        function speak(text) {
            if (speechSynthesis.speaking) return;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ko-KR';
            utterance.rate = 1.2;
            speechSynthesis.speak(utterance);
        }

        async function setupWebcam() {
            // --- ëª¨ë°”ì¼ ìµœì í™”ì˜ í•µì‹¬ ---
            // 'facingMode: "environment"'ëŠ” ìŠ¤ë§ˆíŠ¸í°ì˜ í›„ë©´ ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ìš”ì²­í•©ë‹ˆë‹¤.
            const constraints = {
                video: {
                    facingMode: 'environment'
                }
            };
            // -------------------------

            return new Promise((resolve, reject) => {
                navigator.mediaDevices.getUserMedia(constraints)
                    .then(stream => {
                        video.srcObject = stream;
                        video.addEventListener('loadeddata', resolve, false);
                    })
                    .catch(error => {
                        // í›„ë©´ ì¹´ë©”ë¼ ì‹¤íŒ¨ ì‹œ ì „ë©´ ì¹´ë©”ë¼ë¡œ ì¬ì‹œë„
                        console.warn('í›„ë©´ ì¹´ë©”ë¼ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì „ë©´ ì¹´ë©”ë¼ë¡œ ì‹œë„í•©ë‹ˆë‹¤.');
                        navigator.mediaDevices.getUserMedia({ video: true })
                            .then(stream => {
                                video.srcObject = stream;
                                video.addEventListener('loadeddata', resolve, false);
                            })
                            .catch(err => reject(err));
                    });
            });
        }

        async function predict() {
            const predictions = await model.detect(video);

            const videoAspectRatio = video.videoWidth / video.videoHeight;
            const canvasAspectRatio = canvas.width / canvas.height;
            const scale = Math.min(canvas.width / video.videoWidth, canvas.height / video.videoHeight);
            const xOffset = (canvas.width - video.videoWidth * scale) / 2;
            const yOffset = (canvas.height - video.videoHeight * scale) / 2;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = '16px "Noto Sans KR", sans-serif';
            ctx.textBaseline = 'top';

            const currentDetections = new Set();

            predictions.forEach(prediction => {
                const objectName = prediction.class;
                currentDetections.add(objectName);

                if (!previouslyDetected.has(objectName)) {
                    speak(objectName);
                }
                
                const [x, y, width, height] = prediction.bbox;
                const label = `${objectName} (${Math.round(prediction.score * 100)}%)`;
                
                // ì¢Œí‘œ ìŠ¤ì¼€ì¼ë§
                const scaledX = x * scale + xOffset;
                const scaledY = y * scale + yOffset;
                const scaledWidth = width * scale;
                const scaledHeight = height * scale;

                ctx.strokeStyle = '#00FFFF';
                ctx.lineWidth = 2.5;
                ctx.strokeRect(scaledX, scaledY, scaledWidth, scaledHeight);
                
                ctx.fillStyle = '#00FFFF';
                const textWidth = ctx.measureText(label).width;
                ctx.fillRect(scaledX, scaledY, textWidth + 8, 22);
                
                ctx.fillStyle = '#000000';
                ctx.fillText(label, scaledX + 4, scaledY + 2);
            });

            previouslyDetected = currentDetections;

            requestAnimationFrame(predict);
        }
        
        async function run() {
            try {
                statusDiv.innerText = 'ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...';
                await setupWebcam();
                statusDiv.innerText = 'ì¹´ë©”ë¼ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.';
                statusDiv.classList.replace('alert-info', 'alert-success');
            } catch (e) {
                console.error(e);
                statusDiv.innerText = 'ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                statusDiv.classList.replace('alert-info', 'alert-danger');
                return;
            }

            statusDiv.innerText = 'ê°ì²´ ì¸ì‹ ëª¨ë¸ì„ ë¡œë”©í•©ë‹ˆë‹¤...';
            statusDiv.classList.replace('alert-success', 'alert-info');
            model = await cocoSsd.load();
            statusDiv.innerText = 'ëª¨ë¸ ë¡œë”© ì™„ë£Œ! ì¸ì‹ì„ ì‹œì‘í•©ë‹ˆë‹¤.';
            statusDiv.classList.replace('alert-info', 'alert-success');

            predict();
        }

        run();
    </script>
</body>
</html>